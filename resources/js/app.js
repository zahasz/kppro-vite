import './bootstrap';
import './utils';

import Alpine from 'alpinejs';
import persist from '@alpinejs/persist';
import focus from '@alpinejs/focus';

// Importujƒô magazyn theme
import setupThemeStore from './stores/theme';

// Dodaj import Turbo dla obs≈Çugi nawigacji
import * as Turbo from '@hotwired/turbo';

// Sprawd≈∫, czy Alpine ju≈º istnieje (zapobiega wielokrotnym instancjom)
if (!window.Alpine) {
    // Konfiguracja framework√≥w
    Alpine.plugin(persist);
    Alpine.plugin(focus);
    window.Alpine = Alpine;

    // Oznaczamy, ≈ºe Alpine zosta≈Ç zainicjalizowany
    window._alpineInitialized = true;

    // Inicjalizujƒô magazyn theme przed uruchomieniem Alpine
    setupThemeStore();
    
    document.addEventListener('DOMContentLoaded', () => {
        Alpine.start();
        console.log('Alpine uruchomiony - pierwsza instancja');
    });
} else {
    // Upewnij siƒô, ≈ºe magazyn theme zosta≈Ç zainicjalizowany
    if (!Alpine.store('theme')) {
        setupThemeStore();
        console.log('Magazyn theme zainicjalizowany dla istniejƒÖcej instancji Alpine');
    }
    console.log('Alpine ju≈º istnieje - unikam wielokrotnych instancji');
}

// Funkcja inicjalizujƒÖca Turbo - tylko raz
let _turboInitialized = false;
function initializeTurbo() {
    if (_turboInitialized) {
        console.log('Turbo ju≈º zainicjalizowane - pomijam');
        return;
    }
    
    _turboInitialized = true;
    console.log('Inicjalizacja Turbo - pierwsze uruchomienie');
    
    // Konfiguracja Turbo
    Turbo.session.drive = true;
    
    // Ograniczenie liczby r√≥wnoczesnych ≈ºƒÖda≈Ñ Turbo
    configureTurboRequests();
    
    // Konfiguracja nas≈Çuchiwania zdarze≈Ñ
    setupTurboListeners();
}

// Konfiguracja ograniczenia r√≥wnoczesnych ≈ºƒÖda≈Ñ
function configureTurboRequests() {
    let currentRequests = 0;
    const maxConcurrentRequests = 2;
    const originalFetch = window.fetch;

    window.fetch = function(...args) {
        // Sprawd≈∫, czy to jest ≈ºƒÖdanie Turbo
        const isTurboRequest = args[1]?.headers?.accept?.includes('text/html');
        
        if (isTurboRequest) {
            if (currentRequests >= maxConcurrentRequests) {
                // Odrzuƒá nadmiarowe ≈ºƒÖdania
                return Promise.reject(new Error('Too many concurrent requests'));
            }
            
            currentRequests++;
            
            return originalFetch(...args)
                .then(response => {
                    currentRequests--;
                    return response;
                })
                .catch(error => {
                    currentRequests--;
                    throw error;
                });
        }
        
        // Dla nie-Turbo ≈ºƒÖda≈Ñ, przeka≈º dalej
        return originalFetch(...args);
    };
}

// Uruchom inicjalizacjƒô Turbo po za≈Çadowaniu strony
document.addEventListener('DOMContentLoaded', () => {
    initializeTurbo();
    
    // Naprawa link√≥w nawigacyjnych
    fixNavigationLinks();
    
    // ≈Åadowanie dodatkowych modu≈Ç√≥w
    loadModules();
});

// Dodanie obs≈Çugi interakcji miƒôdzy Turbo i Alpine
document.addEventListener('turbo:load', () => {
    // Sprawd≈∫, czy Alpine jest gotowy
    if (window.Alpine) {
        // Sprawd≈∫, czy magazyn theme istnieje i zainicjalizuj go, je≈õli nie
        if (!Alpine.store('theme')) {
            setupThemeStore();
            console.log('Magazyn theme zainicjalizowany podczas turbo:load');
        }
        
        // Od≈õwie≈º komponenty Alpine
        document.querySelectorAll('[x-data]').forEach(el => {
            if (el.__x) {
                el.__x.updateElements(el);
            }
        });
    }
    
    // Naprawa link√≥w nawigacyjnych
    fixNavigationLinks();
    
    // ≈Åadowanie dodatkowych modu≈Ç√≥w
    loadModules();
});

// Naprawa link√≥w nawigacyjnych, aby poprawnie dzia≈Ça≈Çy z Turbo
function fixNavigationLinks() {
    // Logi diagnostyczne
    console.log('Fixing navigation links...');
    
    // Zliczanie link√≥w przed naprawƒÖ
    const allLinks = document.querySelectorAll('a[href]:not([data-turbo="false"])');
    const unfixedLinks = document.querySelectorAll('a[href]:not([data-turbo="false"]):not([data-fixed="true"])');
    console.log(`Total links: ${allLinks.length}, Unfixed links: ${unfixedLinks.length}`);
    
    document.querySelectorAll('a[href]:not([data-turbo="false"]):not([data-fixed="true"])').forEach(link => {
        // Pomijamy linki zewnƒôtrzne, maile, nr telefon√≥w, itp.
        if (
            link.getAttribute('href').startsWith('#') ||
            link.getAttribute('href').startsWith('http') ||
            link.getAttribute('href').startsWith('mailto:') ||
            link.getAttribute('href').startsWith('tel:') ||
            link.getAttribute('target') === '_blank'
        ) {
            // Oznaczamy te linki r√≥wnie≈º, aby nie by≈Çy sprawdzane ponownie
            link.setAttribute('data-fixed', 'true');
            return;
        }
        
        // Oznaczamy link jako ju≈º naprawiony
        link.setAttribute('data-fixed', 'true');
        link.setAttribute('data-turbo', 'true');
        
        // Dodajemy obs≈Çugƒô klikniƒôcia tylko je≈õli link nie ma jeszcze obs≈Çugi
        if (!link._clickHandlerAdded) {
            link._clickHandlerAdded = true;
            
            link.addEventListener('click', (e) => {
                // Zapobiegamy wielokrotnemu klikniƒôciu podczas przetwarzania
                if (link.getAttribute('data-processing') === 'true') {
                    e.preventDefault();
                    console.log('Preventing multiple clicks on link:', link.href);
                    return;
                }
                
                // Dodajemy klasƒô aktywnƒÖ
                link.classList.add('pointer-events-none', 'opacity-70');
                link.setAttribute('data-processing', 'true');
                
                // Dodajemy efekt ≈Çadowania
                document.body.classList.add('turbo-loading');
                
                // Resetujemy stan po zako≈Ñczeniu nawigacji lub po timeout
                setTimeout(() => {
                    link.classList.remove('pointer-events-none', 'opacity-70');
                    link.removeAttribute('data-processing');
                }, 1000);
            });
        }
    });
    
    // Log po naprawie
    console.log('Navigation links fixed');
}

// Dodaj funkcjƒô debugowania na stronie
function showDebugMessage(message, type = 'info') {
    // Sprawd≈∫ czy tryb debugowania jest w≈ÇƒÖczony
    const debugMode = document.documentElement.getAttribute('data-debug') === 'true';
    if (!debugMode) return;

    // Bardziej widoczne logi konsolowe
    console.log('%c[DEBUG] ' + message, 'font-weight: bold; font-size: 14px; color: ' + (type === 'error' ? 'red' : 'blue') + '; background: #f0f0f0; padding: 3px 5px; border-radius: 3px;');
    
    // Dodaj wiadomo≈õƒá do strony
    let debugContainer = document.getElementById('js-debug-messages');
    if (!debugContainer) {
        debugContainer = document.createElement('div');
        debugContainer.id = 'js-debug-messages';
        debugContainer.className = 'fixed top-2 left-2 z-[9999] flex flex-col gap-2 max-w-xs';
        document.body.appendChild(debugContainer);
    }
    
    const msgElement = document.createElement('div');
    msgElement.className = 'bg-rose-600 text-white font-medium text-base p-3 rounded-lg shadow-xl border-2 border-white';
    
    // Dodanie ikony zale≈ºnie od typu wiadomo≈õci
    const icon = type === 'error' ? '‚ùå' : 'üîç';
    msgElement.textContent = `${icon} ${message}`;
    
    debugContainer.appendChild(msgElement);
    
    // Usu≈Ñ po 10 sekundach (d≈Çu≈ºszy czas)
    setTimeout(() => {
        try {
            debugContainer.removeChild(msgElement);
        } catch (e) {}
    }, 10000);
}

// Funkcja wy≈õwietlania informacji o wersji
function showVersionInfo() {
    // Sprawd≈∫ czy tryb debugowania jest w≈ÇƒÖczony
    const debugMode = document.documentElement.getAttribute('data-debug') === 'true';
    if (!debugMode) return;

    // Poka≈º informacje o wersji
    const versionElement = document.createElement('div');
    versionElement.className = 'fixed bottom-2 left-2 bg-indigo-600 text-white text-base font-bold p-3 rounded-lg shadow-xl z-[9999] border-2 border-white';
    versionElement.textContent = `üëæ Wersja: 1.3.1 | ${new Date().toLocaleString()}`;
    document.body.appendChild(versionElement);
    
    // Wy≈õwietl tak≈ºe informacje o przeglƒÖdarce
    showDebugMessage(`PrzeglƒÖdarka: ${navigator.userAgent.substring(0, 50)}...`);
}

// Konfiguracja nas≈Çuchiwania zdarze≈Ñ Turbo
function setupTurboListeners() {
    // Log wersji
    console.log('Konfiguracja Turbo - v1.3.1');
    showDebugMessage('Konfiguracja Turbo v1.3.1');
    
    // Poka≈º informacje o wersji
    showVersionInfo();
    
    // Przed rozpoczƒôciem nawigacji
    document.addEventListener('turbo:before-visit', (event) => {
        document.body.classList.add('turbo-loading');
        showDebugMessage('Rozpoczynam nawigacjƒô: ' + event.detail?.url);
        
        // Zapis stanu menu przed nawigacjƒÖ
        const adminSidebarOpen = localStorage.getItem('admin_sidebar_state');
        if (adminSidebarOpen) {
            // Zapisz w sesji stan menu przed nawigacjƒÖ (kr√≥tkotrwa≈Çe przechowywanie)
            sessionStorage.setItem('_preserve_sidebar_state', adminSidebarOpen);
            console.log('Zapisano stan menu przed nawigacjƒÖ:', adminSidebarOpen);
            showDebugMessage('Zapisano stan menu: ' + adminSidebarOpen);
        }
    });
    
    // Po zako≈Ñczeniu nawigacji
    document.addEventListener('turbo:visit', () => {
        document.body.classList.remove('turbo-loading');
    });
    
    // Obs≈Çuga b≈Çƒôd√≥w Turbo
    document.addEventListener('turbo:load', () => {
        document.body.classList.remove('turbo-loading');
        showDebugMessage('Strona za≈Çadowana');
        
        // Przywr√≥ƒá stan menu po nawigacji
        const preservedState = sessionStorage.getItem('_preserve_sidebar_state');
        if (preservedState) {
            console.log('Przywracanie stanu menu po nawigacji:', preservedState);
            showDebugMessage('Przywracanie stanu menu: ' + preservedState);
            
            localStorage.setItem('admin_sidebar_state', preservedState);
            
            // Opcjonalnie - aktualizacja UI je≈õli Alpine jeszcze nie zaktualizowa≈Ç stanu
            setTimeout(() => {
                const adminSection = document.querySelector('[data-section="admin"]');
                if (adminSection) {
                    console.log('Wysy≈Çanie zdarzenia od≈õwie≈ºenia menu');
                    showDebugMessage('Od≈õwie≈ºanie menu');
                    adminSection.dispatchEvent(new CustomEvent('refresh-sidebar'));
                }
            }, 100);
        }
    });
    
    // Obs≈Çuga b≈Çƒôd√≥w
    document.addEventListener('turbo:load', (event) => {
        if (event.detail?.error) {
            errorHandler(event.detail.error);
            showDebugMessage('B≈ÇƒÖd ≈Çadowania: ' + event.detail.error.message, 'error');
        }
    });
}

// Dynamiczne ≈Çadowanie modu≈Ç√≥w zale≈ºne od sekcji strony
const loadedModules = new Set();

async function loadModules() {
    try {
        // Debug - identyfikator wywo≈Çania
        const callId = Math.random().toString(36).substring(2, 8);
        
        // Sprawdzenie czy modu≈Çy sƒÖ ju≈º za≈Çadowane
        if (window.modulesLoaded) {
            console.log(`[loadModules:${callId}] Modu≈Çy ju≈º za≈Çadowane, pomijam duplikat wywo≈Çania`);
            return;
        }
        
        // Dodanie flagi aby zapobiec wielokrotnym ≈Çadowaniom
        window.modulesLoaded = true;
        
        console.log(`[loadModules:${callId}] Pr√≥ba za≈Çadowania modu≈Ç√≥w dla strony: ${window.location.pathname}`);
        
        // Sprawdzanie sekcji admin
        const adminSection = document.querySelector('[data-section="admin"]');
        if (adminSection && !loadedModules.has('admin')) {
            try {
                console.log(`[loadModules:${callId}] ≈Åadowanie modu≈Çu admin...`);
                loadedModules.add('admin'); // Dodaj wcze≈õniej do zestawu, aby zapobiec duplikatom
                
                // Dodaj obs≈Çugƒô stabilno≈õci menu (zapobiega rozwijaniu/zwijaniu)
                const sidebarState = localStorage.getItem('admin_sidebar_state');
                console.log(`[loadModules:${callId}] Stan menu zapisany w localStorage: ${sidebarState}`);
                
                // Powiadom, ≈ºe administratorzy sƒÖ za≈Çadowani
                adminSection.dispatchEvent(new CustomEvent('admin-module-ready'));
                
                const adminModule = await import('./admin/index.js');
                console.log(`[loadModules:${callId}] Modu≈Ç admin za≈Çadowany pomy≈õlnie`);
            } catch (error) {
                console.error(`[loadModules:${callId}] Nie uda≈Ço siƒô za≈Çadowaƒá modu≈Çu admin:`, error);
            }
        }
        
        // Sprawdzanie sekcji dashboard
        const dashboardSection = document.querySelector('[data-section="dashboard"]');
        if (dashboardSection && !loadedModules.has('dashboard')) {
            try {
                console.log(`[loadModules:${callId}] ≈Åadowanie modu≈Çu dashboard...`);
                loadedModules.add('dashboard'); // Dodaj wcze≈õniej do zestawu, aby zapobiec duplikatom
                const dashboardModule = await import('./dashboard.js');
                console.log(`[loadModules:${callId}] Modu≈Ç dashboard za≈Çadowany pomy≈õlnie`);
            } catch (error) {
                console.error(`[loadModules:${callId}] Nie uda≈Ço siƒô za≈Çadowaƒá modu≈Çu dashboard:`, error);
            }
        }
    } catch (error) {
        errorHandler(error);
    }
}

// Obs≈Çuga trybu ciemnego
document.addEventListener('DOMContentLoaded', () => {
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (darkModeToggle) {
        darkModeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark ? 'true' : 'false');
        });
        
        // Ustawienie poczƒÖtkowego stanu
        if (localStorage.getItem('darkMode') === 'true' || 
            (window.matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('darkMode'))) {
            document.documentElement.classList.add('dark');
        }
    }
});
